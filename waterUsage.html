<!DOCTYPE html>
<html lang="{{ site.lang | default: "en-US" }}">
  <head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <p style = "font-family: sans, sans-serif; fill: gray">
    According to the City of Fort Collins, "half of a home's annual water usage typically goes toward lawn watering".This visualization shows the daily water demand of Fort Collins, CO. 

  </p>
<script src="//d3js.org/d3.v6.js"></script>
<body>
  <svg id="myPlot" style="width:1000px;height:900px;margin:10px;">
    <defs>
      <marker
        id="arrow"
        markerUnits="strokeWidth"
        markerWidth="11"
        markerHeight="11"
        viewBox="0 0 11 11"
        refX="6"
        refY="6"
        orient="auto">
        <path d="M2,2 L10,6 L2,10 L6,6 L2,2" style="fill: gray;"></path>
      </marker>
    </defs>            
  </svg>
  <script>

 d3.csv("joined_df.csv", function(data) {
   return(
    const width = 640;
    const height = 400;
    const marginTop = 20;
    const marginRight = 30;
    const marginBottom = 30;
    const marginLeft = 40;

    // Set the x-axis labels to Monthly abbreviations
    let tickLabels = ["Jan", "Feb", "March", "Apr", "May", "June", "July", "Aug", "Sept", "Oct", "Nov", "Dec"]

    // Create a linear x-axis scale (0 = Jan, 11 = Dec)
    const x = d3.scaleLinear()
    .range([marginLeft, width - marginRight])
        .domain([0, 11]);

    // Create a linear y-axis scale that ranges from the min to max data input
    const y = d3.scaleLinear()
        .domain([d3.min(data, d => d.min), d3.max(data, d => d.max)])
        .range([height - marginBottom, marginTop]);

    // Create an svg container for the visualization
    const svg = d3.create("svg")
        .attr("viewBox", [0, 0, width, height])
        .attr("width", width)
        .attr("height", height)
        .attr("style", "max-width: 100%; height: auto;");

    //Create a color scale for the forecasted probabilities
    var color_scale = d3.scaleQuantize()
    .domain([0, 100])
    .range(["#F5F1A0", "#D4EAC3", "#ACC8DC", "#06667E"]); //yellow, green, light blue, blue

    // Define a function for the normal cdf in order to calculate the forecasted probabilites
    function normalcdf(mean, sigma, to) {
        var z = (to-mean)/Math.sqrt(2*sigma*sigma);
        var t = 1/(1+0.3275911*Math.abs(z));
        var a1 =  0.254829592;
        var a2 = -0.284496736;
        var a3 =  1.421413741;
        var a4 = -1.453152027;
        var a5 =  1.061405429;
        var erf = 1-(((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*Math.exp(-z*z);
        var sign = 1;
        if(z < 0) {
            sign = -1; 
        }
        return (1/2)*(1+sign*erf)*100;
    }

    // Visualization code

    // Append the x-axis 
    svg.append("g")
        .attr("transform", `translate(0,${height - marginBottom})`)
        .call(d3.axisBottom(x).tickFormat((d,i) => tickLabels[i]));

    // Append the y-axis
    svg.append("g")
        .attr("transform", `translate(${marginLeft},0)`)
        .call(d3.axisLeft(y));

    // Append the top tercile 
    svg.append("g")
        .selectAll("rect")
        .data(data)
        .join("rect")
        .attr("fill", d => color_scale(normalcdf(d.monthly_avg, Math.sqrt(d.monthly_var), d.max) - normalcdf(d.monthly_avg, Math.sqrt(d.monthly_var), d.third)))
        .attr("x", d => x(d.Month))
        .attr("y", d => y(d.max))
        .attr("width", 3)
        .attr("length", d => y(d.third) - y(d.max))

    // Append the middle tercile 
    svg.append("g")
        .selectAll("rect")
        .data(data)
        .join("rect")
        .attr("fill", d => color_scale(normalcdf(d.monthly_avg, Math.sqrt(d.monthly_var), d.third) - normalcdf(d.monthly_avg, Math.sqrt(d.monthly_var), d.second)))
        .attr("x", d => x(d.Month))
        .attr("y", d => y(d.third))
        .attr("width", 3)
        .attr("length", d => y(d.second) - y(d.third))

    // Append the bottom tercile
    svg.append("g")
        .selectAll("rect")
        .data(data)
        .join("rect")
        .attr("fill", d => color_scale(normalcdf(d.monthly_avg, Math.sqrt(d.monthly_var), d.second) - normalcdf(d.monthly_avg, Math.sqrt(d.monthly_var), d.min)))
        .attr("x", d => x(d.Month))
        .attr("y", d => y(d.second))
        .attr("width", 3)
        .attr("length", d => y(d.min) - y(d.second))

        });




  </script>
</body>
</div>
